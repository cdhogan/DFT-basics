# Electronic charge density
This exercise demonstrates the post-processing of data from a previous self-consistent result. For example, we can ask to visualize the electronic charge density, or the electrostatic potential, or to look at a particular wavefunction in real space.

Most (but not all) post-processing can be performed using the `pp.x` code. 

A description of the input files for the pp.x code can be found at [INPUT_PP.html](http://https://www.quantum-espresso.org/Doc/INPUT_PP.html) or by opening the file PP/Docs/INPUT_PP.html in QE's source folder.

Here we will compute the electronic charge density and write it into files that can be plotted in 1D or visualized in 3D using `XCrySDen`. 

We adopt the kinetic energy cutoff, k-point mesh, and lattice parameter determined in the previous steps.

  1. Run the self consistent calculation using the provided input file 'si.scf.in'
      ```
      % pw.x < si.scf.in > si.scf.out
      ```
  2. Inspect the provided input file `charge1D.in`. The file is divided into a `&inputpp` namelist, that controls the quantity to be computed via the variable `plot_num`, and a `&plot` namelist that controls the format of the output datafile. 
     ```
     &inputpp
     prefix="Si"
     outdir="./tmp"
     filplot="charge.dat"
     plot_num=0
     /
     &plot
     iflag=1
     output_format=0
     fileout="charge_plot1D.dat"
     x0(1)=0.00, x0(2)=0.00, x0(3)=0.00
     e1(1)=0.25, e1(2)=0.25, e1(3)=0.25
     nx=1001
     /
     ```
     In this case we set `plot_num=0` that corresponds to the electronic (pseudo)-charge density, and ask to plot it along a line between the two silicon atoms in the unit cell (x0=origin;e1=vector;alat units;nx=number of points).

     Now run the post processing code `pp.x` using the provided input 'charge1D.in'. 
     It reads the ground state charge density of the system from the file 'tmp/Si.save/charge-density.dat' generated by the previous run. 
      ```
      % pp.x < charge1D.in > charge1D.out
      ```
      As well as the (trivial) `charge1D.out` file, it creates a datafile `charge_plot1D.dat` that we can plot with e.g. gnuplot.
      ```
      % gnuplot
      gnuplot> plot "charge_plot1D.dat" w l
      ```
      ![charge density](Ref/charge_plot1D.png?raw=true "charge density")

      Is it what you expect?
  
  4. Now let's look at the charge density throughout the cell using a 3D analysis. Run the code again with `charge3D.in` and plot the output file 'charge_plot3D.xsf' using XCrySDen
      ```
      % cat charge3D.in
      [...]
      &plot
      iflag=3
      output_format=5
      fileout="charge_plot3D.xsf"
      /
      ```
      Note the different choices for iflag and output_format.
      ```
      % pp.x < charge3D.in > charge3D.out
      % xcrysden --xsf charge_plot_3D.xsf
      ```
  5. Open the menu: `Tools` -> `Data Grid` and select `ok` until the Isosurface window opens.

  6. Input an `isovalue` of about 1/10th of the `maximum grid value` and click `submit`. What are you looking at? Is it what you expect?
     (If you use a laptop with a small monitor: xcrysden has some bugs and the `submit` buttom could be out of your monitor size.
      Try clicking on `Plane #1` which should make the `submit` button visible)
     ![charge density](Ref/charge1.png?raw=true "charge density")

     To see the isosurface better, try increasing the number of cells drawn. From the main XCrysDen menu select `View` -> `Number of units drawn` and make a 3x3x3 cell. In the Isosurface window you will need to select `Expand to whole surface` and Submit again to refresh the plot. 

  7. Now try a much higher value, 90-95% near the maximum. What are you looking at now? How does it relate to the 1D plot you did first?
     ![charge density](Ref/charge2.png?raw=true "charge density")

     A key message here is: be very careful when interpreting data from 3D isosurface plots! It is easy to trick yourself. The isovalue must be chosen carefully.
  
  8. Instead of XCrysDen, you can view geometries, isosurfaces, planes, etc with other packages such as VESTA. VESTA can read both the .xsf format data or the more common .cube format. Let's generate also a .cube format file.

      ```
      % pp.x < charge3D_cube.in > charge3D_cube.out
      % VESTA charge_plot3D.xsf
      % VESTA charge_plot3D.cube
      ```

  9. ADVANCED: The `pp.x` tool can plot a lot of useful physical quantities. For example, to know more about the electronic bonding in bulk Si, we can plot the so-called _electron localization function_ (ELF) by putting `plot_num=8`. The ELF is derived from the probability of finding two electrons with the same spin near each other â€” something Pauli exclusion makes less likely in localized regions. It is defined between 0 and 1, where 1.0 corresponds to regions of high pair density (e.g. lone pairs, covalent bonds); 0.5 corresponds to metallic or electron gas behaviour; and 0.0 indicates low electron density. Have a look at [1] to understand the results. 
     ![ELF](Ref/elf.png?raw=true "ELF")

     Alternatively, we can plot the _charge density minus superposition of atomic densities_ with `plot_num=9.` This gives an indication of how the electronic charge redistributes when atoms couple together. (NB: take care with the meaning of the atomic reference state).

## Bibliography
1. Koumpouras and Andreas Larsson, J. Phys.: Condens. Matter 32 (2020) 315502 (12pp) [Link](https://doi.org/10.1088/1361-648X/ab7fd8)
Distinguishing between chemical bonding and physical binding using electron localization function (ELF)

### When you have completed this tutorial, you can move on to [4_bandstructure: Computing the bands](../4_bandstructure)
